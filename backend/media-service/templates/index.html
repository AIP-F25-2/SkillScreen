<!DOCTYPE html>
<html>
<head>
    <title>Video Admin Dashboard</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; color: #333; margin: 0; padding: 0; }
        .container { width: 95%; margin: 20px auto; }
        h1, h2 { text-align: center; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        table, th, td { border: 1px solid #ccc; }
        th, td { padding: 8px; text-align: left; }
        th { background: #007bff; color: #fff; }
        tr:nth-child(even) { background: #f9f9f9; }
        button { padding: 5px 10px; margin-right: 5px; cursor: pointer; border: none; border-radius: 4px; background: #28a745; color: #fff; }
        button.delete { background: #dc3545; }
        button.preview { background: #17a2b8; }
        .flex-row { display: flex; align-items: center; margin-bottom: 10px; gap: 5px; flex-wrap: wrap; }
        input[type=text] { padding: 5px; border: 1px solid #ccc; border-radius: 4px; }
        .section { padding: 20px; background: #fff; border-radius: 6px; margin-bottom: 20px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
        .recording-section video { max-width: 400px; border: 1px solid #ccc; margin-top: 10px; border-radius: 4px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Admin Video Dashboard</h1>

        <!-- Recording Section -->
        <div class="section recording-section">
            <h2>Recording Control</h2>
            <div class="flex-row">
                <input type="text" id="recordUserId" placeholder="Enter User ID for Recording">
                <button id="startRecBtn">Start Recording</button>
                <button id="stopRecBtn" disabled>Stop Recording</button>
            </div>
            <video id="livePreview" autoplay muted style="display:none;"></video>
        </div>

        <!-- Users Section -->
        <div class="section">
            <h2>Users Management</h2>
            <div class="flex-row">
                <input type="text" id="newUserId" placeholder="New User ID">
                <button onclick="createUser()">Create User</button>
                <button onclick="loadUsers()">Load Users</button>
                <button onclick="deleteAllUsers()" class="delete">Delete All Users</button>
            </div>
            <table id="usersTable">
                <thead>
                    <tr><th>User ID</th><th>Actions</th><th>Videos</th></tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <!-- Videos Section -->
        <div class="section">
            <h2>Search Videos</h2>
            <div class="flex-row">
                <input type="text" id="videoQuery" placeholder="Search videos">
                <button onclick="searchVideos()">Search</button>
            </div>
            <table id="videosTable">
                <thead>
                    <tr><th>User</th><th>Video</th><th>Actions</th></tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

<script>
async function fetchJSON(url, options) {
    const res = await fetch(url, options);
    return await res.json();
}

// ---------------------- Recording ----------------------
let mediaRecorder, recordedChunks = [], liveStream;

document.getElementById('startRecBtn').addEventListener('click', async () => {
    const userId = document.getElementById('recordUserId').value.trim();
    if (!userId) return alert('Enter User ID');

    // Reset chunks automatically
    await fetchJSON('/reset_chunks', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ user_id: userId })
    });

    liveStream = await navigator.mediaDevices.getUserMedia({ video:true, audio:true });
    const preview = document.getElementById('livePreview');
    preview.srcObject = liveStream;
    preview.style.display = 'block';

    recordedChunks = [];
    mediaRecorder = new MediaRecorder(liveStream, { mimeType:'video/webm; codecs=vp8,opus' });

    mediaRecorder.ondataavailable = async function(e) {
        if (e.data.size > 0) {
            recordedChunks.push(e.data);
            const formData = new FormData();
            const chunkFilename = `${Date.now()}.webm`;
            formData.append('file', new Blob([e.data], {type:'video/webm'}), chunkFilename);
            formData.append('user_id', userId);
            await fetch('/upload_chunk', { method:'POST', body:formData });
        }
    };

    mediaRecorder.start(1000); // chunk every 1 second
    document.getElementById('startRecBtn').disabled = true;
    document.getElementById('stopRecBtn').disabled = false;
});

document.getElementById('stopRecBtn').addEventListener('click', async () => {
    const userId = document.getElementById('recordUserId').value.trim();
    if (!userId) return alert('Enter User ID');

    mediaRecorder.stop();
    liveStream.getTracks().forEach(track => track.stop());
    document.getElementById('livePreview').style.display = 'none';
    document.getElementById('startRecBtn').disabled = false;
    document.getElementById('stopRecBtn').disabled = true;

    // Wait a bit to ensure last chunks are uploaded
    await new Promise(r => setTimeout(r, 1000));

    // Finalize upload
    const data = await fetchJSON('/finalize_upload', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ user_id: userId })
    });

    alert(`Recording finalized: ${data.file}`);
    loadUserVideos(userId);
});

// ---------------------- Users ----------------------
async function loadUsers() {
    const data = await fetchJSON('/admin/users');
    const tbody = document.querySelector('#usersTable tbody');
    tbody.innerHTML = '';
    data.users.forEach(user => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${user}</td>
            <td>
                <button onclick="renameUser('${user}')">Rename</button>
                <button onclick="deleteUser('${user}')" class="delete">Delete</button>
            </td>
            <td><div id="videos-${user}">Loading...</div></td>`;
        tbody.appendChild(tr);
        loadUserVideos(user);
    });
}

async function createUser() {
    const userId = document.getElementById('newUserId').value.trim();
    if (!userId) return alert('Enter User ID');
    await fetchJSON('/admin/user', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({user_id: userId})
    });
    loadUsers();
}

async function renameUser(oldId) {
    const newId = prompt('New User ID for ' + oldId);
    if (!newId) return;
    await fetchJSON(`/admin/user/${oldId}`, {
        method:'PUT',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({new_user_id: newId})
    });
    loadUsers();
}

async function deleteUser(userId) {
    if (!confirm(`Delete user ${userId}?`)) return;
    await fetchJSON(`/admin/user/${userId}`, { method:'DELETE' });
    loadUsers();
}

async function deleteAllUsers() {
    if (!confirm('Delete ALL users?')) return;
    await fetchJSON('/admin/users', { method:'DELETE' });
    loadUsers();
}

// ---------------------- Videos ----------------------
async function loadUserVideos(userId) {
    const div = document.getElementById(`videos-${userId}`);
    const data = await fetchJSON(`/admin/videos/${userId}`);
    if (!data.videos || data.videos.length === 0) {
        div.innerHTML = 'No videos';
        return;
    }
    div.innerHTML = '';
    data.videos.forEach(video => {
        const videoDiv = document.createElement('div');
        videoDiv.innerHTML = `${video} 
            <button class="preview" onclick="previewVideo('${userId}','${video}')">Preview</button>
            <button class="delete" onclick="deleteVideo('${userId}','${video}')">Delete</button>`;
        div.appendChild(videoDiv);
    });
}

async function deleteVideo(userId, filename) {
    if (!confirm(`Delete video ${filename}?`)) return;
    await fetchJSON(`/admin/video/${userId}/${filename}`, { method:'DELETE' });
    loadUserVideos(userId);
}

function previewVideo(userId, filename) {
    const win = window.open(`/admin/video/${userId}/preview/${filename}`, '_blank');
    if (!win) alert('Popup blocked, enable popups to preview');
}

async function searchVideos() {
    const query = document.getElementById('videoQuery').value.trim();
    const data = await fetchJSON(`/admin/search/videos?q=${encodeURIComponent(query)}`);
    const tbody = document.querySelector('#videosTable tbody');
    tbody.innerHTML = '';
    for (let user in data.matched_videos) {
        data.matched_videos[user].forEach(video => {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${user}</td>
                <td>${video}</td>
                <td>
                    <button class="preview" onclick="previewVideo('${user}','${video}')">Preview</button>
                    <button class="delete" onclick="deleteVideo('${user}','${video}')">Delete</button>
                </td>`;
            tbody.appendChild(tr);
        });
    }
}

// Initial load
loadUsers();
</script>
</body>
</html>
